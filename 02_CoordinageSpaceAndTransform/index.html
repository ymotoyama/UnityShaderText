<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="ROBOTS" content="NOINDEX,NOFOLLOW,NOARCHIVE">
    <title>座標空間と変換</title>
    <link rel="stylesheet" href="../style.css">
    <style>
       
    </style>
  </head>
  <body>
    <p class="title">座標空間と変換</p>
    <ol id="mozToc">
    </ol>
    シェーダーを使いこなすには「<strong>座標空間</strong>」と「<strong>変換</strong>」を理解している必要があります。<br>
    シェーダーに必要な座標変換の知識について学んでいきます。
    <h1>座標空間の種類</h1>
    <p>コンピューターでモノの場所を表すには座標を使います（(x=2, y=0, z=5)といったように)。</p>
    <p>そのとき、座標空間はいくつもの種類が考えられます。</p>
    <ul>
      <li>オブジェクト空間</li>
      <li>ワールド空間</li>
      <li>ビュー空間</li>
      <li>クリップ空間</li>
      <li>正規化デバイス座標空間</li>
      <li>スクリーン空間</li>
    </ul>
    <p>なお、「座標空間」は英語で「<strong>Coordinate Space</strong>」といいます。</p>
    <p>また、この資料では「空間」と呼びますが「座標系」という単語も同じ意味です。<br>
      例：「ワールド座標系」は「ワールド空間」と同じものを指しています。</p>
    <h2>説明の前提条件</h2>
    <p>これから、座標空間の説明を図で示しながら説明していきます。<br>
      次のようなシチュエーションを説明していきます。</p>
    <img src="image/base.gif" alt="">
    <h2>オブジェクト空間</h2>
    <img src="image/model_space.png" alt="">
    <p>モデリングソフトでモデリングするとき、普通はキャラクターの中心や足元を原点(0, 0, 0)にして、作成します。<br>
      このとき、各頂点の位置を表している空間が「<strong>オブジェクト空間</strong>」です。</p>
    <p>「<strong>モデル空間</strong>」や「<strong>ローカル空間</strong>」と呼ぶ場合もあります。</p>
    <h2>ワールド空間</h2>
    <p>3Dモデルをゲームの世界に配置します。<br>
      ゲームの世界では原点(0, 0, 0)が決まっており、各オブジェクトは、原点からどれくらい離れているかで場所を表します。</p>
    <img src="image/world_space.png" alt="">
    <p>これが「<strong>ワールド空間</strong>」です。</p>
    <br>
    <h2>ビュー空間</h2>
    <p>3D CGの描画において、カメラの位置と向きは非常に重要です。<br>
      カメラの位置と向きによって、画面に映る内容がまるで変わるからです。</p>
    <p>3D CGでは、カメラからの視点を実現するために「<strong>ビュー空間</strong>」という座標空間を使用します。<br>
      これは、<strong>カメラを中心とした座標空間</strong>です。</p>
    <img src="image/view_space.png" alt="">
    <p>つまり、CGの世界では、カメラを動かすということは、カメラ以外の全てのオブジェクトを逆向きに動かすということなのです。<br>
      カメラをY軸方向に+1するということは、全てのオブジェクトをY軸方向に-1するのと同じことなのです。<br>
      「学校に行くのめんどくさいなあ。学校が俺のところに来てくれれば良いのに」と考えたことはありませんか？<br>
      現実では難しいですが、CGの世界ではこれを行って描画をしています。</p>
    <p>なお、ビュー空間は「<strong>カメラ空間</strong>」や「<strong>Eye空間</strong>」と呼ばれることもありますが、まったく同じものを指しています。</p>
    <h2>クリップ空間</h2>
    <p>3D CGでは、ビュー空間からさらに「<strong>クリップ空間</strong>」に変換します。</p>
    <p>カメラには、映る範囲を左右するいくつかのパラメーターがあります。</p>
    <ul>
      <li>視野角</li>
      <li>NearとFar（近クリップ面と遠クリップ面）</li>
    </ul>
    <p>これらの設定を反映した空間がクリップ空間です。</p>
    <img src="image/clip_space.png" alt="">
    <p>カメラのNearからFarまでの範囲が、Z軸の-1～+1になります（※環境によって異なる。<strong>現行のUnityの場合はNearの場所が1、Farの場所が0となる</strong>（Reversed-Zという手法らしい））。</p>
    <p>文献によっては、「クリップ空間」と後述する「正規化デバイス座標空間」を混同しているものがあるので気をつけましょう。</p>
    <p><strong>頂点シェーダーの役割は、オブジェクト空間の座標をクリップ空間まで変換すること</strong>です。<br>
      3D CGを画面に表示するには、クリップ空間から、さらにいくつかの変換が必要なのですが、それらはグラフィックスAPIが勝手にやってくれます。</p>
    <p>クリップ空間に関しては、完全に理解していなくても、シェーダーを書くうえでほとんど問題になりませんが、「詳しく理解していないと気持ち悪い！」という人は、こちらのサイトを見てみてください。おそらくクリップ空間について日本一詳しく解説している記事です。<br>
      <a href="http://marupeke296.com/DXG_No70_perspective.html">マルペケつくろードットコム　その70 完全ホワイトボックスなパースペクティブ射影変換行列</a></p>
    <h2>正規化デバイス座標空間</h2>
    <p>クリップ空間をさらに変換し、<strong>画面に映る範囲のx, y, zを-1～+1の範囲にした座標空間</strong>です（※例によって、環境によって異なる）。</p>
    <img src="image/dnc.png" alt="">
    <p>カメラの視錐台（カメラに映る範囲）が立方体になっている空間です。<br>
      カメラに近いものは大きく、遠いものは小さくなっています。<br>
    </p>
    <p>上図の赤い範囲はx, y, zが-1～+1の範囲となっています。</p>
    <p>「正規化デバイス座標空間」は英語でいうと「Normalized Device Coordinate（NDC）」または「Normalized Device Coordinate Space（NDCS）」と呼ばれます。</p>
    <h2>スクリーン空間</h2>
    <p>スクリーン（モニター）の解像度に合わせて、デバイス正規化座標空間のxとyを変換した空間です。</p>
    <img src="image/screen_space.png" alt="">
    <p>↑フルHD（1980✕1080）のスクリーンに表示する場合の例<br>
    </p>
    <p>このスクリーン空間にまで変換されて、ようやく、頂点が画面のどのピクセルに来るかがわかるわけです。</p>
    <p class="column"><b>ラスタライズ<br>
      </b><br>
      スクリーン空間まで変換しても、頂点が画面のどのピクセルに来るかがわかっただけで、どのピクセルを塗りつぶすべきかは、まだわかりません。それを行うのが「ラスタライズ」と呼ばれる処理になります。<br>
      <br>
      ラスタライズに関しては、GPUが勝手にやってくれるので、プログラマーが行うことはありませんが、存在は把握しておきましょう。<br>
      <br>
      <img src="image/pipeline.gif" alt=""><br>
      <br>
      <img src="image/rasterize.gif" alt=""><br>
      引用元：<a href="https://www.atmarkit.co.jp/fdotnet/directxworld/directxworld07/directxworld07_01.html"
        target="_blank">https://www.atmarkit.co.jp/fdotnet/directxworld/directxworld07/directxworld07_01.html</a></p>
    <p><br>
    </p>
    <h1>変換</h1>
    <p>前章でオブジェクト空間からスクリーン空間までの遥かな旅路を見てきましたが、今度は、それぞれの空間から空間へ変換する処理について見ていきます。</p>
    <h2>モデル変換</h2>
    <p>オブジェクト空間をワールド空間に変換することを「<strong>モデル変換</strong>」といいます。</p>
    <p>モデル変換を行う行列を「<strong>モデル行列</strong>」といいます（ワールド変換行列ともいいます）。</p>
    <img src="image/world_transform.gif" alt="">
    <h2>ビュー変換</h2>
    <p>ワールド空間をビュー空間に変換することを「<strong>ビュー変換</strong>」といいます。</p>
    <p>ビュー変換を行う行列を「<strong>ビュー行列</strong>」といいます。</p>
    <img src="image/view_transform.gif" alt="">
    <h2>プロジェクション変換</h2>
    <p>ビュー空間をクリップ空間に変換することを「<strong>プロジェクション変換</strong>」といいます（ビュー空間からデバイス正規化座標空間までの変換をまとめて「プロジェクション変換」と呼ぶ文献も多いです）。</p>
    <p>プロジェクション変換を行う行列を「<strong>プロジェクション行列</strong>」といいます。</p>
    <p>頂点シェーダーで行うべき作業はここまでになります。</p>
    <img src="image/view_to_clip.gif" alt="">
    <h2>透視除算（W除算）</h2>
    <p>ここから先は、あなたが行う必要はなく、GPUが勝手にやってくれる処理になります。</p>
    <p>クリップ空間を正規化デバイス座標空間に変換する処理を「<strong>透視除算（W除算）</strong>」といいます。</p>
    <img src="image/clip_to_dnc.gif" alt="">
    <p>行列のwの値でx, y, zを割ることから、そう呼ばれています。</p>
    <h2>ビューポート変換</h2>
    <p>正規化デバイス座標空間をスクリーン空間に変換することを「<strong>ビューポート変換</strong>」といいます（「スクリーン座標変換」ともいう）。</p>
    <p>ビューポート変換を行う行列を「<strong>ビューポート行列</strong>」といいます。</p>
    <h2>まとめ</h2>
    <p>オブジェクト空間からクリップ空間までの間は、シェーダーを書くうえで必須の知識なので、よく覚えておいてください。</p>
    <p><img src="image/TransformMatome.png" alt=""> </p>
    <p><br>
    </p>
    <h1>MVP行列</h1>
    <p>頂点シェーダーの役割は、オブジェクト空間の座標をクリップ空間に変換することです。<br>
      その際、変形を行うような特殊なシェーダーを作りたければ、ワールド空間やビュー空間で加工を行いますが、一般的なほとんどの頂点シェーダーでは、流れ作業のごとくオブジェクト空間からクリップ空間に変換します。</p>
    <p>頂点シェーダーは頂点の数だけ呼ばれます。<br>
      頂点の数だけモデル変換、ビュー変換、そしてプロジェクション変換を行うと、累計で膨大な回数の行列の掛け算を行うことになります。</p>
    <p>ここで、「行列の掛け算はまとめておくことができる」という行列の特徴が活きてきます。<br>
      この特徴により、下記の①と②は同じ結果になります。<br>
      ①ある座標Pに行列Aをかけて変換し、その結果に行列Bをかけて変換した結果<br>
      ②あらかじめ行列Aと行列Bをかけておいて、それと座標Pをかけて変換した結果</p>
    <p>あるひとつの3Dモデルの各頂点において、必要なモデル行列、ビュー行列、プロジェクション行列は同じなので、あらかじめモデル行列とビュー行列とプロジェクション行列をかけてひとつにまとめておきます。この行列を<strong>MVP行列</strong>といいます。</p>
    <p>あとは、全ての頂点に対して、同じMVP行列を使います。これで計算量が1/3になります。</p>
    <p>なお、Unityにおいては、Unityが勝手にMVP行列を用意してくれます。</p>
    <p><br>
    </p>
    <p><br>
    </p>
    <p><a href="../">目次へ戻る</a></p>
    <p><br>
    </p>
  </body>
</html>
